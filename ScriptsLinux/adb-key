#!/bin/bash
set -e
scriptName=$(basename "$(test -L "$0" && readlink "$0" || echo "$0")")

function fn_help () {
    echo "Usage: $scriptName [OPTION]"
    echo ""
    echo "  -k KEY, --key KEY         send a keyevent to a connected device"
    echo "  -i TEXT, --input TEXT     send a text input to a connected device"
    echo "  -K, --keyboard            enter keyboard mode (type keys directly to device)"
    echo "  -ss, --shake              send a shake event to a connected device"
    echo "  -s SERIAL                 use device with given serial"
    echo "  -h, --help                show this help"
    echo ""
    echo "Examples:"
    echo "  $scriptName -k HOME"
    echo "  $scriptName -i \"hello world\""
    echo "  $scriptName -K"
    echo "  $scriptName -ss"
    echo "  $scriptName -s SERIAL -k HOME"
    echo "  $scriptName -s SERIAL -i \"hello world\""
    echo "  $scriptName -s SERIAL -K"
    echo "  $scriptName -s SERIAL -ss"
    exit 0
}

function fn_shake () {
    if [ $# == 1 ]; then
        adb shell input keyevent 82
        exit 0
    fi 
    if [ $# == 2 ]; then
        adb -s $1 shell input keyevent 82
        exit 0
    fi
    exit 1
}

function fn_keyevent () {
    function get_key_event () {
        keyCode=$1
        if [ "$1" == "UP" ]; then keyCode=DPAD_UP; fi
        if [ "$1" == "DOWN" ]; then keyCode=DPAD_DOWN; fi
        if [ "$1" == "LEFT" ]; then keyCode=DPAD_LEFT; fi
        if [ "$1" == "RIGHT" ]; then keyCode=DPAD_RIGHT; fi
        if [ "$1" == "ESC" ]; then keyCode=ESCAPE; fi
        keyCode=${keyCode^^}
    }
    if [ $# == 1 ]; then
        if [ "$1" == "" ]; then echo "$scriptName: missing KEY operator"; exit 1; fi
        get_key_event $1
        adb shell input keyevent KEYCODE_$keyCode
        exit 0
    fi 
    if [ $# == 2 ]; then
        if [ "$2" == "" ]; then echo "$scriptName: missing KEY operator"; exit 1; fi
        get_key_event $2
        adb -s $1 shell input keyevent KEYCODE_$keyCode
        exit 0
    fi
    exit 1
}

function fn_input () {
    if [ $# == 1 ]; then
        if [ "$1" == "" ]; then echo "$scriptName: missing KEY operator"; exit 1; fi
        text=`echo $2 | sed "s/\s/\%s/g"`
        adb shell input text "$text"
        echo "Written to device > $2" 
        exit 0
    fi 
    if [ $# == 2 ]; then
        if [ "$2" == "" ]; then echo "$scriptName: missing KEY operator"; exit 1; fi
        text=`echo $2 | sed "s/\s/\%s/g"`
        adb -s $1 shell input text "$text"
        echo "Written to device > $2" 
        exit 0
    fi
}

function fn_keyboard() {
    IFS=
    echo "CTRL + C to terminate"
    escape_char=$(printf "\u1b")

    while read -rsn1 key; do
        if [[ $key == $escape_char ]]; then
            read -rsn2 rest
            key+="$rest"
            if [[ "$rest" == "OP" || "$rest" == "OQ" || "$rest" == "OR" || "$rest" == "OS" ]]; then
                :
            else
                read -rsn1 extra
                key+="$extra"
            fi
        fi
        case $key in
            $'\eOP') key="F1" ;;
            $'\eOQ') key="F2" ;;
            $'\eOR') key="F3" ;;
            $'\eOS') key="F4" ;;
            $'\e[15') key="F5" ;;
            $'\e[17') key="F6" ;;
            $'\e[18') key="F7" ;;
            $'\e[19') key="F8" ;;
            $'\e[20') key="F9" ;;
            $'\e[21') key="F10" ;;
            $'\e[23') key="F11" ;;
            $'\e[24') key="F12" ;;
            $'\e') key="ESCAPE" ;;
            '[A')  key="DPAD_UP" ;;
            '[B')  key="DPAD_DOWN" ;;
            '[D')  key="DPAD_LEFT" ;;
            '[C')  key="DPAD_RIGHT" ;;
            '[3')  key="BACKSPACE" ;;
            '')    key="RETURN" ;;
            ' ')   key="SPACE" ;;
            *)     key="${key:0:1}" ;;
        esac
        #echo "\{$key\} \{$escape_char\}"
        [ "$key" == "" ] && echo -ne "Key does not exist\033[0K\r"
        if [ $# == 1 ]; then
            adb -s $1 shell input keyevent KEYCODE_$key
        else
            adb shell input keyevent KEYCODE_$key
        fi
        sleep 0.1
    done
    exit 0
}

function main () {
    if [[ "$*" == *"--help"* ]] || [[ "$*" == *"-h"* ]]; then
        fn_help
    fi

    # Args handle
    if [[ "$1" == "-ss" ]] || [[ "$1" == "--shake" ]] || [[ "$3" == "-ss" ]] || [[ "$3" == "--shake" ]]; then
        if [ "$#" != 2 ]; then echo "$scriptName: invalid option '$1'"; fi
        if [ "$#" != 4 ]; then echo "$scriptName: invalid option '$3'"; fi
        if [ "$#" == 1 ]; then fn_shake; fi
        if [ "$#" == 3 ]; then fn_shake $2; fi
    fi

    if [ "$1" == "-k" ] || [ "$1" == "--key" ] || [ "$3" == "-k" ] || [ "$3" == "--key" ]; then
        if [ "$#" == 2 ]; then fn_keyevent $2; fi
        if [ "$#" == 4 ]; then fn_keyevent $2 $4; fi
    fi
    if [ "$1" == "-i" ] || [ "$1" == "--input" ] || [ "$3" == "-i" ] || [ "$3" == "--input" ]; then
        if [ "$#" == 2 ]; then fn_input $2; fi
        if [ "$#" == 4 ]; then fn_input $2 $4; fi
    fi
    if [ "$1" == "-K" ] || [ "$1" == "--keyboard" ] || [ "$3" == "-K" ] || [ "$3" == "--keyboard" ]; then
        if [ "$#" == 1 ]; then fn_keyboard; fi
        if [ "$#" == 3 ]; then fn_keyboard $2; fi
    fi

    # Nothing done
    if [ "$1" == "" ]; then echo "$scriptName: missing file operand"; fi
    if [ "$1" != "" ]; then echo "$scriptName: invalid option '$1'"; fi
    echo "Try '$scriptName --help' for more information."
    exit 1

}

main $*